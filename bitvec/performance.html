<!DOCTYPE HTML>
<html lang="en-US" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Performance - A User’s Guide to the Ferrilab Project</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="A more thorough exploration of Ferrilab’s crates.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href=".././guide/assets/mdbook-admonish.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../dedication.html">Dedication</a></li><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction to Ferrilab</a></li><li class="chapter-item expanded "><a href="../radium.html"><strong aria-hidden="true">2.</strong> Radium</a></li><li class="chapter-item expanded "><a href="../funty.html"><strong aria-hidden="true">3.</strong> funty</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../funty/permission-changes.html"><strong aria-hidden="true">3.1.</strong> Permission Changes</a></li></ol></li><li class="chapter-item expanded "><a href="../bitvec.html"><strong aria-hidden="true">4.</strong> bitvec</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../bitvec/data-structures.html"><strong aria-hidden="true">4.1.</strong> Data Structures</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../bitvec/data-structures/bitslice.html"><strong aria-hidden="true">4.1.1.</strong> BitSlice</a></li><li class="chapter-item expanded "><a href="../bitvec/data-structures/bitarray.html"><strong aria-hidden="true">4.1.2.</strong> BitArray</a></li><li class="chapter-item expanded "><a href="../bitvec/data-structures/bitvec.html"><strong aria-hidden="true">4.1.3.</strong> BitVec and BitBox</a></li></ol></li><li class="chapter-item expanded "><a href="../bitvec/type-parameters.html"><strong aria-hidden="true">4.2.</strong> Type Parameters</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../bitvec/type-parameters/bitorder.html"><strong aria-hidden="true">4.2.1.</strong> BitOrder</a></li><li class="chapter-item expanded "><a href="../bitvec/type-parameters/bitstore.html"><strong aria-hidden="true">4.2.2.</strong> BitStore</a></li></ol></li><li class="chapter-item expanded "><a href="../bitvec/practical-use.html"><strong aria-hidden="true">4.3.</strong> Practical Use</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../bitvec/practical-use/collections.html"><strong aria-hidden="true">4.3.1.</strong> bool Collections</a></li><li class="chapter-item expanded "><a href="../bitvec/practical-use/bitfields.html"><strong aria-hidden="true">4.3.2.</strong> C-Style Bitfields</a></li></ol></li><li class="chapter-item expanded "><a href="../bitvec/memory-representation.html"><strong aria-hidden="true">4.4.</strong> Memory Representation</a></li><li class="chapter-item expanded "><a href="../bitvec/memory-model.html"><strong aria-hidden="true">4.5.</strong> Memory Model</a></li><li class="chapter-item expanded "><a href="../bitvec/performance.html" class="active"><strong aria-hidden="true">4.6.</strong> Performance</a></li><li class="chapter-item expanded "><a href="../bitvec/pointer-encoding.html"><strong aria-hidden="true">4.7.</strong> Pointer Encoding</a></li><li class="chapter-item expanded "><a href="../bitvec/miscellaneous.html"><strong aria-hidden="true">4.8.</strong> Other Features</a></li></ol></li><li class="chapter-item expanded "><a href="../afterword.html">Afterword</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">A User’s Guide to the Ferrilab Project</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ferrilab/ferrilab" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="runtime-performance"><a class="header" href="#runtime-performance">Runtime Performance</a></h1>
<p><code>bitvec</code> increases the instruction cost of each access to a <code>bool</code> in its data
structures. This is an inevitable consequence of the fact that, even on
architectures that have them, compilers typically do not emit object code
instructions that access individual bits within a memory location. Therefore,
each access in <code>bitvec</code> has, in addition to a memory operation, one or two
shift instructions one or two <code>AND</code>/<code>OR</code>/<code>NOT</code> instructions.</p>
<p>This means that, inevitably, <code>bitvec</code> is slower in CPU time than <code>[bool]</code> is.
Measurements indicate roughly a factor of ten, but with also about 10x more
variance. However, this cost is only apparent <em>and meaningful</em> when walking the
entirety of very large buffers, and tends to fade into noise on smaller buffers,
or be obviated by compile-time fixed accesses. As always, try it on a
representative workload.</p>
<h2 id="benchmarking"><a class="header" href="#benchmarking">Benchmarking</a></h2>
<p>I have tried (with admittedly low priority) to have some benchmarks in the
project to back up my claims that <code>bitvec</code> is fast. This has been difficult to
maintain for a few reasons, but I have at least a few that have stayed present
in order to demonstrate important claims, such as showing that specialization
for matching types does provide massive performance benefits (it does).</p>
<p>In particular, LLVM is <em>very good</em> at propagating compile-time constants through
the code, and <code>bitvec</code> strives to maintain an internal implementation that is
easily accessible to optimizers. This means that basically any benchmark that
takes input from a source file that the compiler can see gets artificially
solved during codegen.</p>
<p>For instance, I don’t know how long it takes to construct a <code>&amp;BitSlice</code> view
over memory, because my benchmarks report 0ns: LLVM computes my pointer encoding
at compile time, and a consequence of the way I designed my pointer encoding is
that the only operation <code>BitSlice::from_slice</code> actually performs is <code>.len &lt;&lt; 3</code>.
When LLVM can see the original length, it just does this itself, and emits an
immediate with the correct length instead of the constructor call.</p>
<p>Other constructor benchmarks are only showing me the time required to run
<code>memcpy</code>, and arbitrary indexing just shows the time required to run three
instructions, because LLVM solved the shift/mask arguments ahead of time.</p>
<p>The important takeäway here is that if your code is at all dependent on
constants that the compiler can see, and is not exclusively performing indexing
based on runtime inputs, then <code>bitvec</code> is going to be <em>plenty</em> fast.</p>
<h2 id="pitfalls"><a class="header" href="#pitfalls">Pitfalls</a></h2>
<p>Everything stated above relies on having information available to the compiler.
<code>bitvec</code> falls behind other bit-reading libraries when you start using access
patterns only known at runtime, such as iteration.</p>
<p>Until Rust stabilizes the <code>ptr_metadata</code> feature (see <a href="https://github.com/rust-lang/rust/issues/81513">#81513</a>), <code>bitvec</code> will
necessarily take a performance hit because it has to decode the <code>&amp;BitSlice</code>
pointer every time you access memory, and reëncode it every time you munch
through the region.</p>
<p>The <code>bitvec</code> pointer encoding (described <a href="./pointer-encoding.html">here</a>) requires manipulating
both words in the pointer with at least three instructions each.</p>
<pre><code class="language-admonish info">Except when using `u8` storage, which discards *most* of the modifications to
the address half of the pointer. Try that out if you do a lot more munching
through a region than bulk work on its contents!
</code></pre>
<p>This would not be necessary if the pointer could use its own metadata type
rather than <code>usize</code>. Until that stabilizes, the entire value proposition of the
crate rests on the fact that <code>&amp;BitSlice</code> has slice-pointer ABI. If you
absolutely cannot afford to have decoding/reëncoding costs in your hot loop, you
may have to try other libraries.</p>
<p><code>bitvec</code> strives to use batch operations on entire integer registers when
possible. However, doing so requires routing through the <code>domain</code> module, which
has to perform similar decoding and processing of a <code>&amp;BitSlice</code> pointer every
time it is entered. This is another unavoidable cost. It is <em>generally</em> a
tolerable overhead compared to walking through each bit individually, especially
with wider storage integers, but it is one more thing that other bit-addressing
libraries don’t do.</p>
<p>Other libraries also do not have alias safety or tolerance for starting a region
away from the zero-index in an integer. Power has a price. We do our best to cut
down the library’s runtime cost as much as possible, but this computation simply
has to be done somewhere, and it's not built in to silicon anymore. Sorry.</p>
<h2 id="specialization"><a class="header" href="#specialization">Specialization</a></h2>
<p><code>bitvec</code> strives to use its knowledge of the underlying memory representation
wherever possible. This means that operations between <code>BitSlice</code>s with the same
type parameters can rely on an identical representation and use integer behavior
rather than walking each bit individually.</p>
<p>Try to do this wherever possible, especially in performance-sensitive code. You
typically should not be mixing <code>bitvec</code> structures with different type
parameters anyway: use the representation that serves your needs, and keep using
it in all buffers that interact with it.</p>
<p>As an example, as of 1.0, walking two large <code>BitSlice</code>s with incompatible type
parameters takes 3µs (microseconds), while walking the same sizes with
identical type parameters takes 100ns (nanoseconds). It’s roughly a 32x
performance difference, which is only half the speedup that I expected using
<code>usize</code> on a 64-bit machine, but still quite stark.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../bitvec/memory-model.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../bitvec/pointer-encoding.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../bitvec/memory-model.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../bitvec/pointer-encoding.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
