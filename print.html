<!DOCTYPE HTML>
<html lang="en-US" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>A User’s Guide to the Ferrilab Project</title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="A more thorough exploration of Ferrilab’s crates.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="dedication.html">Dedication</a></li><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction to Ferrilab</a></li><li class="chapter-item expanded "><a href="radium.html"><strong aria-hidden="true">2.</strong> Radium</a></li><li class="chapter-item expanded "><a href="funty.html"><strong aria-hidden="true">3.</strong> funty</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="funty/permission-changes.html"><strong aria-hidden="true">3.1.</strong> Permission Changes</a></li></ol></li><li class="chapter-item expanded "><a href="afterword.html">Afterword</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">A User’s Guide to the Ferrilab Project</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="dedication"><a class="header" href="#dedication">Dedication</a></h1>
<p>I began working on <code>bitvec</code> shortly before I was told that my father had been
diagnosed with cancer for the third time. Developing the library gave me
something into which to sink my attention and keep my mind from dwelling on his
rapidly-progressing illness. I wrote the core pointer representation that
enables <code>bitvec</code>’s modern behavior at his side, in the last days that he
remained conscious.</p>
<p>I never had the chance to explain to my dad what I was building. By the time it
was developed enough to be worth explaining, he had lost too much of his brain
to understand me. More than anything I’ve done for my employers, <code>bitvec</code> is the
work of which I’m most proud, and which I most wish he could have seen.</p>
<p>The Ferrilab project, and in particular <code>bitvec</code>, is dedicated to the memory of
my father, George M. Payne, who inspired me to build quality work, supported my
search for my talents, and taught me to labor for the benefit of others beyond
myself.</p>
<p>—Alexander Payne (myrrlyn)</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-to-ferrilab"><a class="header" href="#introduction-to-ferrilab">Introduction to Ferrilab</a></h1>
<p>Ferrilab is an umbrella project for crates that experiment with reshaping the
Rust data model about primitive types. It began with the <code>bitvec</code> crate; as
<code>bitvec</code> expanded, it eventually spun off its integer-generalization into
<code>funty</code>, and <code>radium</code> was created independently but swiftly brought into the
fold.</p>
<p>Ferrilab is currently focused on just these three crates, but may expand in the
future as we discover new ideas to try out.</p>
<h2 id="behind-the-name"><a class="header" href="#behind-the-name">Behind the Name</a></h2>
<p>The primary maintainer, myrrlyn, is from the Great Lakes region of the Americas
and the crates here all reshape the fundamental types in the Rust language. We
looked for names that had to do with early modern physics, and settled on Enrico
Fermi, as he worked in atomic physics, has an eponymous laboratory near Chicago,
and Fermilab was a single edit step away from Rust’s mascot.</p>
<p><small>Plus, <code>bitvec</code> began while myrrlyn was working for the US Government in
New Mexico…</small></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="radium"><a class="header" href="#radium">Radium</a></h1>
<p>The <a href="https://crates.io/crates/radium"><code>radium</code></a> crate provides a unifying model for shared-mutability over the
primitives. It does <em>not</em> handle more complex shared-mutability topics such as
mutices or locks: if you need to manage large structured data, you will need to
look elsewhere.</p>
<h2 id="radium-trait"><a class="header" href="#radium-trait"><code>Radium</code> Trait</a></h2>
<p>This trait allows your code to generically accept either an atomic type or a
<code>Cell</code> and interact with it through a unified API. It is implemented by all of
the standard library atomics, <code>Cell&lt;{bool,{i,u}{8,16,32,64,128,size},*mut T}&gt;</code>,
and the type families that Radium provides (described below).</p>
<p>The primitive type that a <code>Radium</code> implementor encloses is indicated by the
<code>Radium::Item</code> associated type. You can use this as a constraint in your trait
bounds (i.e. <code>&lt;R: Radium&lt;Item = i32&gt;&gt;</code>) in order to gain direct access to the
primitive, or you can require that <code>R::Item</code> implement other traits and interact
with it through them.</p>
<h2 id="type-aliases"><a class="header" href="#type-aliases">Type Aliases</a></h2>
<p>Radium provides type aliases for each primitive which <em>could</em> be atomic in the
standard library. The <code>Radium{Bool,{I,U}{8,16,32,64,128,size},Ptr}</code> symbols all
forward to their corresponding <code>AtomicType</code> when that symbol exists, or to
<code>Cell&lt;Type&gt;</code> when it does not.</p>
<p>Since these are type aliases rather than newtypes, you can globally replace the
<code>AtomicT</code> symbols with their <code>RadiumT</code> equivalent without any other changes to
your codebase.</p>
<h2 id="type-families"><a class="header" href="#type-families">Type Families</a></h2>
<p>Radium provides three type families which accept fundamentals as type
parameters. These families have no inherent API, and only implement <code>Radium</code>,
<code>Debug</code>, <code>Default</code>, and <code>From&lt;T&gt;</code>. They may or may not have a <code>Sync</code>
implementation, depending on whether they have atomic behavior.</p>
<ol>
<li>
<p>The <code>Atom&lt;T&gt;</code> family corresponds to (and wraps) the standard library’s
<code>core::sync::atomic::*</code> types. This family only accepts <code>T</code> parameters where
an equivalent <code>AtomicT</code> symbol exists for the target; this means that on
targets which do not have, for instance, <code>AtomicU64</code>, <code>Atom&lt;u64&gt;</code> will fail
to compile. These are always <code>Sync</code>.</p>
<p><code>Atom</code> requires that type arguments implement <code>radium::marker::Atomic</code>.</p>
</li>
<li>
<p>The <code>Isotope&lt;T&gt;</code> family functions similarly to <code>Atom&lt;T&gt;</code>, except that it
wraps Radium’s <code>RadiumT</code> type aliases. As such, <code>Isotope</code> is portable across
targets with different atomic supports, and will never fail to compile;
however, it will silently degrade from atomic to <code>Cell</code> behavior (including
loss of <code>Sync</code>) when the requisite atomic types are missing.</p>
<p><code>Isotope</code> requires that type arguments implement <code>radium::marker::Nuclear</code>.</p>
</li>
<li>
<p>The <code>Radon&lt;T&gt;</code> family is a wrapper over <code>Cell&lt;T&gt;</code>. Like <code>Isotope</code>, it
requires that type arguments implement <code>radium::marker::Nuclear</code>. It is never
<code>Sync</code>.</p>
</li>
</ol>
<h2 id="examples"><a class="header" href="#examples">Examples</a></h2>
<p>This contrived example is taken from <code>radium/examples/schroedinger.rs</code>. It
shows how the <code>Radium</code> trait can be used by a worker function to manipulate
data, and how the different types can be used to work in sequence or in
parallel.</p>
<blockquote>
<p>Note: Radium’s MSRV is 1.60, while the scoped-threads API used here stabilized
in 1.63.</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust edition2021">use radium::{Radium, types::{RadiumU64, Atom, Isotope, Radon}};
use std::{
  cell::Cell,
  sync::atomic::{AtomicU64, Ordering},
  thread,
  time::Duration,
};

fn do_work&lt;R: Radium&lt;Item = u64&gt;&gt;(this: &amp;R, ident: u8) {
  let on_entry = this.load(Ordering::SeqCst);
  println!(&quot;{: &gt;2} step 0 sees: {: &gt;2}&quot;, ident, on_entry);

  let before_add = this.fetch_add(10, Ordering::SeqCst);
  println!(&quot;{: &gt;2} step 1 sees: {: &gt;2}&quot;, ident, before_add);

  let after_add = this.load(Ordering::SeqCst);
  println!(&quot;{: &gt;2} step 2 sees: {: &gt;2}&quot;, ident, after_add);

  thread::sleep(Duration::from_millis(after_add));

  let before_sub = this.fetch_sub(3, Ordering::SeqCst);
  println!(&quot;{: &gt;2} step 3 sees: {: &gt;2}&quot;, ident, before_sub);

  let on_exit = this.load(Ordering::SeqCst);
  println!(&quot;{: &gt;2} step 4 sees: {: &gt;2}&quot;, ident, on_exit);
}

static ATOM: AtomicU64 = AtomicU64::new(0);
static RADIUM: RadiumU64 = RadiumU64::new(0);

fn main() {
  let cell = Cell::new(0u64);

  let atom = Atom::new(0u64);
  let isotope = Isotope::new(0u64);
  let radon = Radon::new(0u64);

  println!(&quot;atoms&quot;);
  thread::scope(|s| for ident in 0 .. 3 {
    s.spawn(move || do_work(&amp;ATOM, ident));
  });
  println!();
  thread::scope(|s| for ident in 3 .. 6 {
    let atom = &amp;atom;
    s.spawn(move || do_work(atom, ident));
  });
  println!();

  println!(&quot;isotopes&quot;);
  thread::scope(|s| for ident in 6 .. 9 {
    s.spawn(move || do_work(&amp;RADIUM, ident));
  });
  println!();
  for ident in 9 .. 12 {
    do_work(&amp;isotope, ident);
  }
  println!();

  println!(&quot;cells&quot;);
  for ident in 12 .. 15 {
    do_work(&amp;cell, ident);
  }
  println!();
  for ident in 15 .. 18 {
    do_work(&amp;radon, ident);
  }
  println!();
}
</code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="funty"><a class="header" href="#funty"><code>funty</code></a></h1>
<p>The <code>funty</code> crate (<em><strong>fun</strong></em>damental <em><strong>ty</strong></em>pes) provides traits that unify
the Rust non-pointer primitives. It also unifies pointers and references by
lifting access permissions into the trait system.</p>
<h2 id="fundamental-unification"><a class="header" href="#fundamental-unification">Fundamental Unification</a></h2>
<p>The Rust primitives implement the following trait hierarchy and replicate their
standard-library inherent API and trait implementations.</p>
<ul>
<li><strong><code>Fundamental</code></strong>: this is implemented by all primitives: <code>bool</code>, <code>char</code>, all
integers, and both floats. It requires all traits that <em>all</em> primitives
implement, and provides <code>.as_other()</code> methods that can replace <code>as</code>-casts.
<ul>
<li><strong><code>Numeric</code></strong>: this is implemented by all integers and both floats. It adds
the arithmetic operator traits, and methods for converting between the
integer and its raw byte representation.
<ul>
<li><strong><code>Integral</code></strong>: this is implemented by all integers. It adds bit-wise
operator traits, attempted conversions between the other integers, and
bit-shifts. It also provides most of the integer inherent API, as most of
these methods are sign-agnostic.
<ul>
<li><strong><code>Signed</code></strong>: this is implemented only by signed integers. It adds the
absolute-value and sign-testing functions that unsigned integers don’t
support.</li>
<li><strong><code>Unsigned</code></strong>: this is implemented only by unsigned integers. It
provides the <code>{is,next}_power_of_two</code> one-hot methods that only make
sense on unsigned integers.</li>
</ul>
</li>
<li><strong><code>Floating</code></strong>: this is implemented by the floating-point numbers. Unlike
the integral traits, it has a great deal of methods that only exist when
<code>cfg(feature = &quot;std&quot;)</code> is active, as they require the platform <code>libm</code>
mathematics library and are not provided by Rust’s <code>core</code> crate. It also
provides both all of the associated constants, as well as all of the
constants stored in eponymous modules but <em>not</em> associated with the actual
floating-point primitive types.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Additionally, <code>funty</code> provides marker traits for selecting bit-width: for <code>N</code>
in <code>8</code>, <code>16</code>, <code>32</code>, <code>64</code>, and <code>128</code>, the <code>IsN</code> trait is implemented by types
that are exactly that wide, <code>AtLeastN</code> is implemented by types that are that
width or more, and <code>AtMostN</code> is implemented by types that are that width or
less.</p>
<p>You can use these traits as generic constraints in code that needs to accept a
range of different primitives. The integral traits provide Peano constants (zero
and one), and can be constructed from literals for non-<code>const</code> work.</p>
<h2 id="pointer-unification"><a class="header" href="#pointer-unification">Pointer Unification</a></h2>
<p>The <code>funty::ptr</code> module provides <code>Pointer</code> and <code>NonNullPtr</code> types which are
replacements for raw pointers and <code>core::ptr::NonNull</code>, respectively. They work
by lifting the <code>*const T</code>/<code>*mut T</code> distinction into the trait system, through
the <code>Permission</code> trait and the <code>Shared</code>, <code>Unique</code>, and <code>(Shared, Unique)</code> types.</p>
<p>The <code>Permission</code> trait and its implementors implement a less-capable version of
the stacked-borrows experimental model found in Miri. <code>Pointer&lt;T, P&gt;</code> implements
the read-only APIs found on both <code>*const</code> and <code>*mut</code> pointers, while
<code>Pointer&lt;T, Unique&gt;</code> alone implements the write APIs only present on <code>*mut</code>
pointers. Additionally, type-level transitions allow <em>safely</em> casting <code>Unique</code>
pointers down to read-only and back up to <code>Unique</code>, and <em>unsafely</em> casting
directly to a permission that you specify.</p>
<p>The <code>NonNullPtr</code> behaves similarly to <code>Pointer</code>, except that it encloses a
<code>core::ptr::NonNull</code> in order to regain the null-pointer niche optimization. Its
API strives to match both the <code>NonNull</code> and <code>Pointer</code> APIs. As both raw pointers
and <code>NonNull</code> still have large amounts of unstable API surface in the standard
library, these types will continue to grow in response to both Ferrilab’s needs
and the standard library’s evolution.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="permission-changes"><a class="header" href="#permission-changes">Permission Changes</a></h1>
<p><code>funty</code> uses the <code>Permission</code> trait to create a graph of safe transitions
between raw pointers and <code>Pointer</code>, and between different type parameters
attached to <code>Pointer</code> values.</p>
<p><code>Pointer</code>s can be constructed from both raw pointers: <code>*const T</code> produces
<code>Pointer&lt;T, Shared&gt;</code>, and <code>*mut T</code> produces <code>Pointer&lt;T, Unique&gt;</code>. Once
constructed, all <code>Pointer&lt;T, P: Permission&gt;</code> values have access to the
introspective and read-only memory accesses defined on the raw pointers. The
memory-write APIs are only available on <code>Pointer&lt;T, Unique&gt;</code>.</p>
<p>Additionally, the method <code>.cast_shared()</code> moves <code>Pointer</code>s from <code>P</code> to
<code>(Shared, P)</code>. The <code>(Shared, P: Permission)</code> tuple is itself an implementor of
<code>Permission</code>, and can continue to be used as a read-only pointer.
<code>Pointer&lt;T, (Shared, P)&gt;</code> also provides <code>.cast_unshared()</code>, which undoes
<code>.cast_shared()</code> and transitions from <code>(Shared, P)</code> back to <code>P</code>.</p>
<p>All <code>Pointer</code>s can produce <code>*const</code> raw pointers, but only the <code>Unique</code>
permission can produce <code>*mut</code> raw pointers. If you need access to <code>*mut</code>
raw pointers but are in generic code where you cannot satisfactorily prove to
the compiler that you have a <code>Unique</code>, you have two options. The
<code>.unwind_to_unique()</code> method recursively unwinds a <code>(Shared, P)</code> history stack
until it reaches the base, then produces <code>Some</code> pointer if the original
permission was <code>Unique</code> or <code>None</code> if it was <code>Shared</code>. The <code>unsafe</code> method
<code>.cast_mut()</code> unconditionally produces a pointer with <code>Unique</code> permissions, but
may violate Rust’s provenance rules and invoke undefined behavior.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="afterword"><a class="header" href="#afterword">Afterword</a></h1>
<p>Thanks for reading! We hope this guide was useful to you.</p>
<p><strong>Please</strong> feel both welcomed and encouraged to ask us any clarifying questions,
or to <a href="https://github.com/ferrilab/ferrilab/issues/new">file an issue</a> if any of it is confusing or even send a PR if you have
improvements!</p>
<p>Ferrilab has been a work of intensely deep focus and research for over four
years. It is a complex and difficult topic, and we are absolutely certain that
we have information and context that we haven’t sufficiently serialized for
everyone else to see.</p>
<p>Thank you for using our crates. We are delighted that other people have found
our work both interesting and useful, and we’re glad that we’ve been able to
help people like you write better programs.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript">
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>
    </body>
</html>
